name: Laravel CI/CD with Docker

on:
  push:
    branches: ["main"]

env:
  DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/laravel-api
  DOCKER_TAG: latest
  CONTAINER_PORT: 80
  HOST_PORT: 8080
  AWS_SERVER_IP: ${{ secrets.AWS_EC2_HOST }}
  DOCKER_BUILD_DEBUG: 1

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3
        with:
          install: true
          driver-opts: image=moby/buildkit:latest

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }}
          build-args: |
            ENABLE_BUILD_DEBUG=${{ env.DOCKER_BUILD_DEBUG }}
          provenance: false
          no-cache: false
          labels: build_run=${{ github.run_id }}

      - name: Smoke test container
        run: |
          echo "Running container smoke test..."
          docker run -d --name smoke -p 8081:80 ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }}
          sleep 12
          echo "Container logs:"; docker logs --tail 80 smoke || true
          docker rm -f smoke || true

  pre-deploy-check:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Verify EC2 Reachability
        run: nc -zv -w 5 ${{ secrets.AWS_EC2_HOST }} 22

      - name: Validate required secrets
        run: |
          required_secrets=(
            "AWS_EC2_HOST"
            "AWS_SSH_PRIVATE_KEY"
            "REPOSITORY_NAME"
            "DOT_ENV"
            "DB_USERNAME"
            "DB_PASSWORD"
            "STRIPE_SECRET_KEY"
            "STRIPE_PUBLIC_KEY"
          )

          for secret in "${required_secrets[@]}"; do
            if [ -z "${{ secrets[secret] }}" ]; then
              echo "‚ùå Secret '$secret' is missing or empty"
              exit 1
            fi
          done
          echo "‚úÖ All required secrets are present"

  deploy:
    needs: pre-deploy-check
    runs-on: ubuntu-latest
    steps:
      - name: Install SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AWS_SSH_PRIVATE_KEY }}" > ~/.ssh/ec2_key
          chmod 600 ~/.ssh/ec2_key

          # Add EC2 host key if provided, otherwise skip StrictHostKeyChecking
          if [ -n "${{ secrets.AWS_EC2_HOST_KEY }}" ]; then
            echo "${{ secrets.AWS_EC2_HOST_KEY }}" >> ~/.ssh/known_hosts
          fi

      - name: Test SSH Connection
        run: |
          ssh -i ~/.ssh/ec2_key \
              -o StrictHostKeyChecking=no \
              -o ConnectTimeout=10 \
              ${{ secrets.AWS_EC2_USER }}@${{ secrets.AWS_EC2_HOST }} \
              "echo '‚úÖ SSH connection successful' && hostname"

      - name: Deploy Application
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.AWS_EC2_HOST }}
          username: ${{ secrets.AWS_EC2_USER }}
          key: ${{ secrets.AWS_SSH_PRIVATE_KEY }}
          script: |
            set -e  # Exit on error

            echo "üöÄ Starting deployment process..."

            # Install Docker if missing
            if ! command -v docker &> /dev/null; then
              echo "üì¶ Installing Docker..."
              sudo apt-get update
              sudo apt-get install -y docker.io
              sudo systemctl enable docker
              sudo systemctl start docker
              sudo usermod -aG docker $USER
            fi

            # Stop services that may block port 80
            echo "üõë Stopping web servers on port 80..."
            sudo systemctl stop apache2 2>/dev/null || true
            sudo systemctl stop nginx 2>/dev/null || true

            # Docker login
            echo "üîê Logging into Docker Hub..."
            echo "${{ secrets.DOCKERHUB_PASSWORD }}" | sudo docker login -u ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin

            # Stop and remove existing container
            echo "üßπ Cleaning up existing container..."
            if sudo docker ps -q --filter "name=${{ secrets.REPOSITORY_NAME }}" | grep -q .; then
              sudo docker stop "${{ secrets.REPOSITORY_NAME }}" || true
              sudo docker rm "${{ secrets.REPOSITORY_NAME }}" || true
            fi

            # Clean up dangling images
            echo "üßπ Pruning old Docker images..."
            sudo docker image prune -a -f 2>/dev/null || true

            # Pull latest image
            echo "‚¨áÔ∏è Pulling latest Docker image..."
            sudo docker pull ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }}

            # Setup environment directory
            echo "‚öôÔ∏è Setting up environment..."
            REPO_DIR="/tmp/${{ secrets.REPOSITORY_NAME }}"

            # Clean and create directory
            sudo rm -rf "$REPO_DIR"
            sudo mkdir -p "$REPO_DIR"
            sudo chown -R $USER:$USER "$REPO_DIR"

            # Create storage directories
            mkdir -p "$REPO_DIR"/storage/framework/{cache,sessions,views} \
                     "$REPO_DIR"/storage/logs \
                     "$REPO_DIR"/bootstrap/cache

            # Set proper permissions
            chmod -R 775 "$REPO_DIR"/storage "$REPO_DIR"/bootstrap/cache

            # Create initial .env file from secret
            echo "üìÑ Creating .env file..."
            echo "${{ secrets.DOT_ENV }}" > "$REPO_DIR"/.env

            # Debug: Show original content
            echo "üîç Original .env content (first 10 lines):"
            head -n 10 "$REPO_DIR"/.env

            # Update .env file with dynamic values
            echo "‚úèÔ∏è Updating .env file..."

            # Define all environment updates
            declare -A env_updates=(
              ["APP_URL"]="http://${{ env.AWS_SERVER_IP }}"
              ["DB_HOST"]="host.docker.internal"
              ["DB_USERNAME"]="${{ secrets.DB_USERNAME }}"
              ["DB_PASSWORD"]="${{ secrets.DB_PASSWORD }}"
              ["STRIPE_SECRET_KEY"]="${{ secrets.STRIPE_SECRET_KEY }}"
              ["STRIPE_PUBLIC_KEY"]="${{ secrets.STRIPE_PUBLIC_KEY }}"
            )

            # Process each environment variable
            for key in "${!env_updates[@]}"; do
              value="${env_updates[$key]}"

              # Remove existing entry (case insensitive, with optional spaces)
              sed -i "/^[[:space:]]*${key}[[:space:]]*=/Id" "$REPO_DIR"/.env

              # Add new entry at the end
              echo "${key}=${value}" >> "$REPO_DIR"/.env

              echo "  ‚úÖ Set $key"
            done

            # Remove duplicate lines (in case of any)
            awk '!seen[$0]++' "$REPO_DIR"/.env > "$REPO_DIR"/.env.tmp && mv "$REPO_DIR"/.env.tmp "$REPO_DIR"/.env

            # Validate .env file
            echo "üîç Final .env validation:"
            echo "--- Stripe keys ---"
            grep -i stripe "$REPO_DIR"/.env || echo "‚ö†Ô∏è No Stripe keys found"
            echo "--- Database config ---"
            grep -i "DB_" "$REPO_DIR"/.env | grep -v "PASSWORD" || echo "‚ö†Ô∏è No DB config found"

            # Run container
            echo "üê≥ Starting Docker container..."
            sudo docker run -d \
              --name "${{ secrets.REPOSITORY_NAME }}" \
              -p 80:${{ env.CONTAINER_PORT }} \
              --restart unless-stopped \
              -v "$REPO_DIR"/.env:/var/www/html/.env \
              -v "$REPO_DIR"/storage:/var/www/html/storage \
              -v "$REPO_DIR"/bootstrap/cache:/var/www/html/bootstrap/cache \
              ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }}

            echo "‚úÖ Container started: http://${{ env.AWS_SERVER_IP }}"

            # Wait for container to initialize
            echo "‚è≥ Waiting for container to start..."
            sleep 15

            # Check if container is running
            if ! sudo docker ps --filter "name=${{ secrets.REPOSITORY_NAME }}" --filter "status=running" | grep -q .; then
              echo "‚ùå Container failed to start. Logs:"
              sudo docker logs "${{ secrets.REPOSITORY_NAME }}" --tail 50
              exit 1
            fi

            # Set proper permissions inside container
            echo "üîß Setting Laravel permissions..."
            sudo docker exec "${{ secrets.REPOSITORY_NAME }}" bash -c "
              chown -R www-data:www-data storage bootstrap/cache &&
              chmod -R 775 storage bootstrap/cache &&
              find storage -type f -exec chmod 664 {} \;
            " || echo "‚ö†Ô∏è Permission setting failed, but continuing..."

            # Clear Laravel caches
            echo "üßπ Clearing Laravel caches..."
            cache_commands=(
              "config:clear"
              "route:clear"
              "view:clear"
              "cache:clear"
            )

            for cmd in "${cache_commands[@]}"; do
              echo "  Running: php artisan $cmd"
              sudo docker exec "${{ secrets.REPOSITORY_NAME }}" php artisan "$cmd" || echo "  ‚ö†Ô∏è Failed: $cmd"
            done

            # Optimize for production
            echo "‚ö° Optimizing for production..."
            sudo docker exec "${{ secrets.REPOSITORY_NAME }}" php artisan config:cache || true
            sudo docker exec "${{ secrets.REPOSITORY_NAME }}" php artisan route:cache || true

            # Display container info
            echo "üìä Deployment summary:"
            echo "----------------------------------------"
            echo "Container: ${{ secrets.REPOSITORY_NAME }}"
            echo "Image: ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }}"
            echo "URL: http://${{ env.AWS_SERVER_IP }}"
            echo "Status: $(sudo docker inspect --format='{{.State.Status}}' "${{ secrets.REPOSITORY_NAME }}")"
            echo "Started: $(sudo docker inspect --format='{{.State.StartedAt}}' "${{ secrets.REPOSITORY_NAME }}")"
            echo "----------------------------------------"

            # Show recent logs
            echo "üìã Recent container logs:"
            sudo docker logs "${{ secrets.REPOSITORY_NAME }}" --tail 20 || true

      - name: Verify Deployment
        run: |
          echo "üîç Verifying deployment..."
          max_retries=10
          retry_count=0

          while [ $retry_count -lt $max_retries ]; do
            echo "Attempt $((retry_count + 1))/$max_retries..."

            # Try to curl the application
            response=$(curl -s -o /dev/null -w "%{http_code}" -m 10 "http://${{ env.AWS_SERVER_IP }}" || echo "000")

            if [[ "$response" =~ ^[23] ]]; then
              echo "‚úÖ Deployment successful! HTTP Status: $response"
              echo "üåê Application is live at: http://${{ env.AWS_SERVER_IP }}"
              exit 0
            elif [ "$response" = "000" ]; then
              echo "‚è≥ Server not responding yet..."
            else
              echo "‚ö†Ô∏è Server responded with HTTP $response"
            fi

            retry_count=$((retry_count + 1))
            sleep 10
          done

          echo "‚ùå Deployment verification failed after $max_retries attempts"
          echo "Please check the server manually: http://${{ env.AWS_SERVER_IP }}"
          exit 1
